steps:

  # pull docker last cached image
  - name: 'gcr.io/cloud-builders/docker'
    entrypoint: 'bash'
    args: [
      '-c',
      'docker pull gcr.io/${_PROJECT_ID}/$_DEPLOYMENT:latest || true',
    ]

  # build docker image
  - name: 'gcr.io/cloud-builders/docker'
    args: [
      'build',
      '-t', 'gcr.io/${_PROJECT_ID}/$_DEPLOYMENT:$BRANCH_NAME$TAG_NAME-$SHORT_SHA',
      '-t', 'gcr.io/${_PROJECT_ID}/$_DEPLOYMENT:latest',
      '-f', 'Docker-production',
      '--cache-from', 'gcr.io/${_PROJECT_ID}/$_DEPLOYMENT:latest',
      '.'
    ]

  # push docker image to the repository
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'gcr.io/${_PROJECT_ID}/$_DEPLOYMENT:$BRANCH_NAME$TAG_NAME-$SHORT_SHA']
